<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√¥j doplnkov√Ω cyklus üíä</title>

  <!-- Ikony / PWA -->
  <link rel="apple-touch-icon" href="./cyklus.png?v=6">
  <link rel="apple-touch-icon" sizes="180x180" href="./cyklus.png?v=6">
  <link rel="apple-touch-icon" sizes="512x512" href="./cyklus.png?v=6">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" type="image/png" href="./cyklus.png?v=6">
  <meta property="og:image" content="./cyklus.png?v=6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Doplnkov√Ω cyklus">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --card-r: 18px; }
    /* Z√°klad */
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      background: radial-gradient(circle at 50% 0%, #ffffff 0%, #dbeafe 35%, #cbd5e1 100%);
      color:#111827; overflow-x:hidden;
    }
    .app{
      width:100%; max-width:420px;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px) saturate(1.2);
      border-radius:22px; border:1px solid rgba(255,255,255,.5);
      box-shadow:0 8px 25px rgba(0,0,0,.15), inset 0 1px 2px rgba(255,255,255,.6);
      padding:22px;
    }
    /* R√°mik autora */
    .author-box{
      background: linear-gradient(90deg,#6366f1 0%,#3b82f6 100%);
      color:#fff; font-weight:800; text-align:center;
      border-radius:14px; padding:8px 12px; margin-bottom:14px;
      box-shadow:0 4px 10px rgba(0,0,0,.25); letter-spacing:.3px;
    }
    /* Karty doplnkov */
    .supplement-card{
      position:relative; border-radius:20px; padding:16px 18px; margin-bottom:14px;
      display:flex; justify-content:space-between; align-items:center; overflow:hidden;
      transform:translateZ(0);
      box-shadow: inset 0 1px 2px rgba(255,255,255,.6), 0 6px 14px rgba(0,0,0,.25);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .supplement-card:hover{ transform: translateY(-3px) scale(1.02); box-shadow:0 8px 20px rgba(0,0,0,.3); }
    .supplement-card:nth-child(odd){  background: linear-gradient(180deg,#ff5252 0%,#c80000 60%,#5a0000 100%); }
    .supplement-card:nth-child(even){ background: linear-gradient(180deg,#4dff91 0%,#00b35a 60%,#005a2e 100%); }

    .supplement-card.warn{
      background: linear-gradient(180deg,#ffcc00 0%,#ff9900 60%,#cc7a00 100%);
      box-shadow: inset 0 1px 2px rgba(255,255,255,.8), 0 6px 14px rgba(0,0,0,.35);
    }
    .supplement-card.pause{
      background: linear-gradient(180deg,#9ca3af 0%,#4b5563 60%,#1f2937 100%);
      box-shadow: inset 0 1px 2px rgba(255,255,255,.4), 0 6px 14px rgba(0,0,0,.15);
    }
    .supplement-card.pause:hover{ transform:none; }
    .pause-message{ color:#fff; font-weight:700; font-size:.9rem; padding-left:10px; text-align:right; }

    /* Sveteln√Ω preliv */
    .supplement-card::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(120deg, rgba(255,255,255,.8) 0%, transparent 40%, transparent 60%, rgba(255,255,255,.25) 100%);
      opacity:.6; mix-blend-mode:screen; transform:translateX(-100%); animation:shine 6s linear infinite;
    }
    .supplement-card.pause::before{ opacity:.1; animation:none; }
    @keyframes shine{0%{transform:translateX(-100%);opacity:0}40%{opacity:.8}60%{opacity:.8}100%{transform:translateX(120%);opacity:0}}

    .left{ display:flex; flex-direction:column; gap:6px; z-index:2; }
    .left .name{ font-weight:900; font-size:1.05rem; color:#fff; text-shadow:0 2px 4px rgba(0,0,0,.4); }

    .dose-label{ display:inline-block; margin:3px 5px 0 0; padding:4px 9px; border-radius:10px; font-size:.78rem; font-weight:700; color:#fff; }
    .dose-label.green{  background:linear-gradient(180deg,#38ef7d 0%,#11998e 100%); }
    .dose-label.blue{   background:linear-gradient(180deg,#56ccf2 0%,#2f80ed 100%); }
    .dose-label.orange{ background:linear-gradient(180deg,#f7971e 0%,#ffd200 100%); color:#222; }
    .dose-label.gray{   background:linear-gradient(180deg,#d1d5db 0%,#9ca3af 100%); color:#222; }

    .right{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; z-index:2; }
    .time-chip{ display:inline-flex; align-items:center; font-size:.8rem; background:#fff; border-radius:8px; padding:3px 7px; border:1px solid rgba(0,0,0,.15); }

    .right .icon{ font-size:20px; color:#fff; opacity:.9; text-shadow:0 2px 3px rgba(0,0,0,.6); transition: transform .2s ease; }
    .right .icon:hover{ transform:scale(1.2); opacity:1; }

    /* Pills pre denn√Ω prehƒæad */
    .pill.dosage{ color:#034b28; background:linear-gradient(180deg,#caffdd 0%,#9bf2bf 60%,#5ddf96 100%); }
    .pill.time{   color:#5f0b0b; background:linear-gradient(180deg,#ffe0e0 0%,#ffc5c5 60%,#ffaaaa 100%); }

    /* Dni v t√Ω≈ædni */
    .day-cell-compact{ cursor:default; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .day-cell-compact.bg-indigo-600{ background-color:#4f46e5; color:#fff; font-weight:800; transform:scale(1.02); box-shadow:0 4px 6px rgba(0,0,0,.2); }
  </style>
</head>
<body class="flex flex-col items-center p-4">

  <!-- Hlaviƒçka -->
  <img src="./apple-touch-icon.png" alt="Doplnky" class="w-20 h-20 rounded-full shadow-md mb-2">
  <h1 class="text-2xl font-extrabold mb-3 text-center">üíä M√¥j doplnkov√Ω cyklus</h1>

  <div class="app">
    <!-- R√°mik autora nad zoznamom -->
    <div class="author-box">üåü Vytvoril Ivan Kebra Nagast üåü</div>

    <!-- Zoznam doplnkov -->
    <div id="supplementList" class="mb-4"></div>

    <!-- Pridanie doplnku -->
    <div class="flex gap-2 mb-2">
      <input id="newSupplement" type="text" placeholder="N√°zov doplnku‚Ä¶" class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
      <button id="addSupplement" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">Prida≈•</button>
    </div>

    <button id="resetAll" class="w-full bg-red-500 text-white rounded-lg py-2 mt-2 hover:bg-red-600" data-confirm="false">üîÅ Resetova≈• d√°ta</button>
    <button id="enableNotifs" class="w-full bg-green-500 text-white rounded-lg py-2 mt-2 hover:bg-green-600">üîî Povoli≈• notifik√°cie</button>

    <!-- Denn√Ω status + graf -->
    <div class="bg-white rounded-2xl p-5 mt-4 border">
      <h3 class="text-sm text-gray-600 mb-2 font-semibold">Aktu√°lny de≈à:</h3>
      <div id="dayDisplay" class="grid grid-cols-7 gap-1.5 mb-4 text-xs font-semibold text-center"></div>
      <p id="dayStatus" class="text-sm text-gray-600 mb-3 font-medium"></p>
      <div class="flex items-center justify-center">
        <svg width="164" height="164" viewBox="0 0 120 120">
          <defs>
            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#2563eb"/>
              <stop offset="100%" stop-color="#16a34a"/>
            </linearGradient>
          </defs>
          <circle cx="60" cy="60" r="54" stroke="#e5e7eb" stroke-width="10" fill="none"/>
          <circle id="progressCircle" cx="60" cy="60" r="54" stroke="url(#grad)" stroke-width="10" fill="none"
                  stroke-linecap="round" stroke-dasharray="339.292" stroke-dashoffset="339.292"
                  transform="rotate(-90 60 60)"/>
          <text id="progressLabel" x="50%" y="50%" text-anchor="middle" dy="6" font-size="16" class="fill-gray-800">0%</text>
        </svg>
      </div>
      <div id="todayChips" class="mt-3 flex flex-wrap gap-2"></div>
    </div>
  </div>

  <!-- MODAL ‚Äì Pl√°n -->
  <div id="planModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-full">
      <h2 id="modalTitle" class="text-lg font-bold mb-4 text-center">üïì Pl√°n u≈æ√≠vania</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">üìÖ Dni v t√Ω≈ædni</h3>
          <div id="dayChecks" class="grid grid-cols-7 gap-2 text-sm"></div>
        </div>

        <!-- Cyklovanie ‚Äì len na ƒç√≠tanie (ukazuje sa ak je nastaven√©) -->
        <div id="cycleConfigFields" class="border p-3 rounded-lg bg-gray-50 hidden">
          <h3 class="font-semibold mb-2 text-indigo-700">üîÑ Cyklovanie (nastaven√©)</h3>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="text-xs text-gray-500 block">Dƒ∫≈æka cyklu (t√Ω≈ædne):</label>
              <input id="cycleDuration" type="number" class="w-full border rounded-lg px-2 py-1" disabled>
            </div>
            <div class="flex-1">
              <label class="text-xs text-gray-500 block">Dƒ∫≈æka pauzy (t√Ω≈ædne):</label>
              <input id="cyclePause" type="number" class="w-full border rounded-lg px-2 py-1" disabled>
            </div>
          </div>
          <p id="cycleStatusMsg" class="text-sm mt-2 text-red-500 font-medium"></p>
        </div>

        <div>
          <h3 class="font-semibold mb-2">‚è∞ ƒåasy (hh:mm)</h3>
          <div id="timeList" class="space-y-2"></div>
          <button id="addTime" class="mt-2 px-3 py-1 rounded-lg border border-gray-300 text-sm hover:bg-gray-50">+ prida≈• ƒças</button>
        </div>

        <div class="flex gap-2 pt-1">
          <button id="savePlan" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">üíæ Ulo≈æi≈• pl√°n</button>
          <button id="closePlan" class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500">Zavrie≈•</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- helpers ---------- */
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>[...document.querySelectorAll(s)];
    const dayShorts = ["Po","Ut","St","≈†t","Pi","So","Ne"];
    const todayISO  = ()=> new Date().toISOString().slice(0,10);
    const todayShort= ()=> dayShorts[(new Date().getDay()+6)%7]; // Po=0 ‚Ä¶ Ne=6
    const readLS  = (k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };
    const writeLS = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

    // Preddefinovan√© doplnky
    const defaultSupplements = [
      { name:"Ecdysterone", doseQuantity:"1 kapsula", doseContext:"po ra≈àajk√°ch",
        plan:{days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:30"]},
        cycleConfig:{durationWeeks:12, pauseWeeks:4} },

      { name:"Kreat√≠n", doseQuantity:"3 kapsuly", doseContext:"po ra≈àajk√°ch, alebo pred tr√©ningom",
        plan:{days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:30"]},
        cycleConfig:{durationWeeks:10, pauseWeeks:4} },

      { name:"L-Lysine", doseQuantity:"1 tabletka", doseContext:"pred ra≈àajkami",
        plan:{days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:00"]},
        cycleConfig:{durationWeeks:0, pauseWeeks:0} },

      { name:"NMN", doseQuantity:"1 kapsula", doseContext:"pred ra≈àajkami",
        plan:{days:["Po","Ut","St","≈†t","Pi"], times:["08:00"]},
        cycleConfig:{durationWeeks:0, pauseWeeks:0} }, // v√≠kend pauza sa rie≈°i logikou

      { name:"Ashwagandha", doseQuantity:"1 kapsula", doseContext:"po ra≈àajk√°ch, 1 kapsula hodinu pred span√≠m",
        plan:{days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:30","20:30"]},
        cycleConfig:{durationWeeks:0, pauseWeeks:0} },

      { name:"Moringa", doseQuantity:"3 kapsuly", doseContext:"po ra≈àajk√°ch",
        plan:{days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:30"]},
        cycleConfig:{durationWeeks:0, pauseWeeks:0} },

      { name:"Omega-3", doseQuantity:"1 kapsula", doseContext:"po ra≈àajk√°ch",
        plan:{days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:30"]},
        cycleConfig:{durationWeeks:0, pauseWeeks:0} },

      { name:"Move Free Joint Health", doseQuantity:"1 kapsula",
        doseContext:"po ra≈àajk√°ch, 1 kapsula po obede, 1 kapsula hodinu pred span√≠m",
        plan:{days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:30","14:00","20:30"]},
        cycleConfig:{durationWeeks:0, pauseWeeks:0} }
    ];

    let supplements = readLS('supplements', defaultSupplements);
    let history     = readLS('history', {});

    // Inicializ√°cia (doplnenie startDate a cycleConfig)
    function initializeSupplements(){
      supplements.forEach(s=>{
        if(!s.startDate) s.startDate = todayISO();
        if(!s.cycleConfig || s.cycleConfig.durationWeeks===undefined){
          const def = defaultSupplements.find(d=>d.name===s.name);
          s.cycleConfig = def?.cycleConfig || {durationWeeks:0, pauseWeeks:0};
        }
      });
      writeLS('supplements', supplements);
    }

    /* ---------- Cycle Logic ---------- */
    function getCycleStatus(supp){
      const dow = new Date().getDay(); // 0=Ne ‚Ä¶ 6=So

      // NMN - v√≠kend pauza (sobota/nedeƒæa), aj keƒè je v pl√°ne
      if(supp.name==="NMN" && (dow===0 || dow===6)){
        return {status:'PAUSE', message:'V√≠kendov√° pauza. U≈æ√≠vanie sa obnov√≠ v pondelok.'};
      }
      if(!supp.cycleConfig || supp.cycleConfig.durationWeeks===0){
        return {status:'ON', message:''};
      }

      const start = new Date(supp.startDate);
      const now   = new Date();
      const diffDays = Math.ceil(Math.abs(now-start)/(1000*60*60*24));

      const daysInCycle = supp.cycleConfig.durationWeeks*7;
      const daysInPause = supp.cycleConfig.pauseWeeks*7;
      const total       = daysInCycle + daysInPause;

      const into = diffDays % total;

      if(into >= daysInCycle){
        const daysLeftInPause = total - into;
        return {status:'PAUSE', message:`POVINN√Å PAUZA (${supp.cycleConfig.pauseWeeks} t√Ω≈æd≈àov). Zost√°va: ${daysLeftInPause} dn√≠.`};
      }else{
        const daysLeftInCycle = daysInCycle - into;
        if(daysLeftInCycle <= 7){
          return {status:'WARN', message:`‚ö†Ô∏è Cyklus konƒç√≠ o ${daysLeftInCycle} dn√≠. Nasleduje ${supp.cycleConfig.pauseWeeks} t√Ω≈æd≈àov pauza.`};
        }
        const weeksLeft = Math.ceil(daysLeftInCycle/7);
        return {status:'ON', message:`Cyklus: ${supp.cycleConfig.durationWeeks} t√Ω≈æd≈àov. Zost√°va: ${weeksLeft} t√Ω≈æd≈àov.`};
      }
    }

    /* ---------- UI refs ---------- */
    const listEl   = $('#supplementList');
    const addEl    = $('#newSupplement');
    const btnAdd   = $('#addSupplement');
    const btnReset = $('#resetAll');
    const btnNotif = $('#enableNotifs');
    const dayStatus= $('#dayStatus');
    const progressCircle = $('#progressCircle');
    const progressLabel  = $('#progressLabel');
    const todayChips = $('#todayChips');
    const dayDisplay= $('#dayDisplay');
    const planModal = $('#planModal');
    const modalTitle= $('#modalTitle');
    const dayChecks = $('#dayChecks');
    const timeList  = $('#timeList');
    const btnAddTime= $('#addTime');
    const btnSavePlan=$('#savePlan');
    const btnClosePlan=$('#closePlan');
    const cycleConfigFields=$('#cycleConfigFields');
    const cycleDuration   = $('#cycleDuration');
    const cyclePause      = $('#cyclePause');
    const cycleStatusMsg  = $('#cycleStatusMsg');
    let editingIndex = -1;

    /* ---------- Render list ---------- */
    function renderSupplements(){
      listEl.innerHTML = "";
      supplements.forEach((supp,i)=>{
        const cstat = getCycleStatus(supp);
        const isPaused  = cstat.status==='PAUSE';
        const isWarning = cstat.status==='WARN';

        const isToday = supp.plan.days.includes(todayShort());
        const timesToday = isToday ? [...supp.plan.times].sort() : [];

        const row = document.createElement('div');
        row.className = `supplement-card ${(isPaused?'pause':(isWarning?'warn':''))}`;

        const left = document.createElement('div');
        left.className = 'left';

        const quantity = supp.doseQuantity || "1 ks";
        const context  = supp.doseContext  || "r√°no";
        let dosageClass = 'gray';
        if(context.includes('ra≈àajkami') || context.includes('r√°no')) dosageClass='orange';
        else if(context.includes('obed') || context.includes('tr√©ningom')) dosageClass='blue';
        else if(context.includes('veƒçer') || context.includes('span√≠m')) dosageClass='green';

        left.innerHTML =
          `<span class="name">${supp.name}</span>
           <span class="dose-label ${dosageClass}">${quantity} ${context}</span>`;
        row.appendChild(left);

        const right = document.createElement('div');
        right.className = isPaused ? "flex items-center gap-2" : "right";

        if(isPaused){
          const msg = document.createElement('div');
          msg.className = "pause-message";
          msg.innerHTML = `PAUZA<br>${cstat.message.replace('POVINN√Å PAUZA ','')}`;
          right.appendChild(msg);
          const planBtn = document.createElement('button');
          planBtn.className = "icon"; planBtn.title="Pl√°n u≈æ√≠vania"; planBtn.textContent="üïì";
          planBtn.onclick = ()=> openPlan(i);
          right.appendChild(planBtn);
        }else{
          timesToday.forEach(t=>{
            const checked = !!(history[todayISO()] && history[todayISO()][supp.name] && history[todayISO()][supp.name][t]);
            const wrap = document.createElement('label');
            wrap.className = "time-chip";
            wrap.innerHTML = `<input type="checkbox" class="accent-blue-600 time-taken" data-name="${supp.name}" data-time="${t}" ${checked?'checked':''}> ${t}`;
            right.appendChild(wrap);
          });
          if(isWarning){
            const warn = document.createElement('span');
            warn.className = "pause-message text-xs text-center w-full";
            warn.textContent = cstat.message;
            right.appendChild(warn);
          }
          const planBtn = document.createElement('button');
          planBtn.className = "icon"; planBtn.title="Pl√°n u≈æ√≠vania"; planBtn.textContent="üïì";
          planBtn.onclick = ()=> openPlan(i);
          right.appendChild(planBtn);
        }

        const delBtn = document.createElement('button');
        delBtn.className = "icon"; delBtn.title="Odstr√°ni≈•"; delBtn.textContent="‚úñ";
        delBtn.onclick = ()=>{
          supplements.splice(i,1);
          writeLS('supplements', supplements);
          renderAll();
        };
        right.appendChild(delBtn);

        row.appendChild(right);
        listEl.appendChild(row);
      });

      $$('.time-taken').forEach(inp=>{
        inp.addEventListener('change',(e)=>{
          const n = e.target.dataset.name;
          const t = e.target.dataset.time;
          if(!history[todayISO()]) history[todayISO()] = {};
          if(!history[todayISO()][n]) history[todayISO()][n] = {};
          history[todayISO()][n][t] = e.target.checked;
          writeLS('history', history);
          renderAll(false);
        });
      });
    }

    /* ---------- Planner modal ---------- */
    function openPlan(index){
      editingIndex = index;
      const supp = supplements[index];
      modalTitle.textContent = `üïì ${supp.name} ‚Äì Nastavenie cyklu (Dni & ƒåasy)`;

      if(supp.cycleConfig && supp.cycleConfig.durationWeeks>0){
        cycleConfigFields.classList.remove('hidden');
        cycleDuration.value = supp.cycleConfig.durationWeeks;
        cyclePause.value    = supp.cycleConfig.pauseWeeks;
        cycleStatusMsg.textContent = `Zaƒçiatok cyklu: ${supp.startDate}. Cyklus sa opakuje automaticky.`;
      }else{
        cycleConfigFields.classList.add('hidden');
      }

      dayChecks.innerHTML = "";
      dayShorts.forEach(d=>{
        const id = `d-${d}`;
        const lab = document.createElement('label');
        lab.className = "flex flex-col items-center gap-1 text-sm bg-gray-50 p-1 rounded-lg cursor-pointer hover:bg-gray-100";
        lab.innerHTML = `<input type="checkbox" id="${id}" value="${d}" class="accent-blue-600" ${supp.plan.days.includes(d)?'checked':''}><span>${d}</span>`;
        dayChecks.appendChild(lab);
      });

      timeList.innerHTML = "";
      (supp.plan.times.length?supp.plan.times:["08:30"]).sort().forEach(addTimeRow);

      planModal.classList.remove('hidden');
    }
    function addTimeRow(value="08:30"){
      const w = document.createElement('div');
      w.className = "flex items-center gap-2";
      w.innerHTML = `<input type="time" value="${value}" class="time-input border rounded-lg px-3 py-1 flex-1">
                     <button class="px-2 py-1 rounded-lg border border-gray-300 text-red-500 hover:bg-red-50 remove-time">‚úñ</button>`;
      timeList.appendChild(w);
      w.querySelector('.remove-time').onclick = ()=> w.remove();
    }
    btnAddTime.onclick = ()=> addTimeRow();

    btnSavePlan.onclick = ()=>{
      if(editingIndex<0) return;
      const daysSel  = [...dayChecks.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value);
      const timesSel = [...timeList.querySelectorAll('.time-input')].map(i=>i.value).filter(Boolean).sort();
      supplements[editingIndex].plan = { days: daysSel, times: (timesSel.length?timesSel:["08:30"]) };
      writeLS('supplements', supplements);
      planModal.classList.add('hidden');
      renderAll(true);
    };
    btnClosePlan.onclick = ()=> planModal.classList.add('hidden');

    /* ---------- Pridanie nov√©ho doplnku ---------- */
    btnAdd.onclick = ()=>{
      const name = addEl.value.trim();
      if(!name) return;
      const newIndex = supplements.push({
        name,
        doseQuantity:"1 ks",
        doseContext:"r√°no",
        plan:{ days:["Po","Ut","St","≈†t","Pi","So","Ne"], times:["08:30"] },
        startDate: todayISO(),
        cycleConfig:{durationWeeks:0, pauseWeeks:0}
      }) - 1;
      addEl.value = "";
      writeLS('supplements', supplements);
      openPlan(newIndex);
      renderAll();
    };

    /* ---------- Reset ---------- */
    btnReset.onclick = ()=>{
      if(btnReset.dataset.confirm==='true'){
        localStorage.removeItem('supplements');
        localStorage.removeItem('history');
        location.reload();
      }else{
        btnReset.textContent = "KLIKNI ZNOVA PRE POTVRDENIE (Resetuje V≈†ETKO)!";
        btnReset.dataset.confirm='true';
        setTimeout(()=>{ btnReset.textContent="üîÅ Resetova≈• d√°ta"; btnReset.dataset.confirm='false'; }, 3000);
      }
    };

    /* ---------- Progress + chips ---------- */
    function renderProgress(){
      todayChips.innerHTML = "";
      const today = todayISO();
      let total=0, done=0;
      const doses = [];

      supplements.forEach(s=>{
        if(getCycleStatus(s).status==='PAUSE') return;
        if(!s.plan.days.includes(todayShort())) return;
        s.plan.times.forEach(t=>{
          const was = !!(history[today] && history[today][s.name] && history[today][s.name][t]);
          doses.push({name:s.name, time:t, was});
        });
      });

      doses.sort((a,b)=> a.time===b.time ? a.name.localeCompare(b.name) : (a.time<b.time?-1:1));

      doses.forEach(d=>{
        total++; if(d.was) done++;
        const chip = document.createElement('span');
        chip.className = `pill ${d.was?'dosage':'time'} px-2 py-1 rounded-lg text-sm`;
        chip.textContent = `${d.name} ‚Ä¢ ${d.time}${d.was?' ‚úì':''}`;
        todayChips.appendChild(chip);
      });

      const pct = total ? Math.round(done/total*100) : 0;
      const C = 2*Math.PI*54;
      progressCircle.setAttribute('stroke-dasharray', C);
      progressCircle.setAttribute('stroke-dashoffset', C*(1-pct/100));
      progressLabel.textContent = `${pct}%`;

      const weekday = new Date().toLocaleDateString('sk-SK',{weekday:'long'});
      dayStatus.textContent = `üìÖ ${weekday} ‚Äî splnen√© ${done}/${total} d√°vok`;
    }

    /* ---------- De≈à v t√Ω≈ædni ---------- */
    function renderDayDisplay(){
      dayDisplay.innerHTML = "";
      const current = todayShort();
      dayShorts.forEach(d=>{
        const isToday = d===current;
        const el = document.createElement('div');
        el.className = `day-cell-compact ${isToday?'bg-indigo-600 text-white':'bg-gray-100 text-gray-700 hover:bg-indigo-50 hover:text-indigo-700'} p-2 rounded-lg transition`;
        el.textContent = d;
        dayDisplay.appendChild(el);
      });
    }

    /* ---------- Notifik√°cie ---------- */
    btnNotif.onclick = async ()=>{
      try{
        const perm = await Notification.requestPermission();
        if(perm!=='granted'){
          dayStatus.textContent = "‚ùå Notifik√°cie: povoƒæ ich v nastaveniach prehliadaƒça alebo syst√©mu.";
          return;
        }
        scheduleTodayNotifications();
        new Notification("üîî Notifik√°cie povolen√©",{body:"Budem pripom√≠na≈• tvoje ƒçasy."});
      }catch(e){
        dayStatus.textContent = "‚ùå Chyba pri notifik√°ci√°ch.";
      }
    };
    function scheduleTodayNotifications(){
      if(Notification.permission!=='granted') return;
      const now = new Date();
      supplements.forEach(s=>{
        if(getCycleStatus(s).status==='PAUSE') return;
        if(!s.plan.days.includes(todayShort())) return;
        s.plan.times.forEach(t=>{
          const [h,m] = t.split(':').map(Number);
          const at = new Date(); at.setHours(h,m,0,0);
          if(at<=now) return;
          const delay = at - now;
          setTimeout(()=>{
            const was = history[todayISO()] && history[todayISO()][s.name] && history[todayISO()][s.name][t];
            if(!was) new Notification("üíä Pripomienka",{body:`${s.name} ‚Ä¢ ${t}`});
          }, delay);
        });
      });
    }

    /* ---------- Service worker ---------- */
    function registerServiceWorker(){
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      }
    }

    /* ---------- Render all ---------- */
    function renderAll(fromPlanSave=false){
      initializeSupplements();
      renderSupplements();
      renderDayDisplay();
      renderProgress();
      if(fromPlanSave) scheduleTodayNotifications();
    }

    window.addEventListener('load', ()=>{
      renderAll();
      if(typeof Notification!=='undefined' && Notification.permission==='granted') scheduleTodayNotifications();
      registerServiceWorker();
    });
  </script>
</body>
</html>
